<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>59.0</apiVersion>
    <processType>Autolaunched</processType>
    <status>Active</status>
    <label>Case - After Create - Priority High</label>
    <description>Record-Triggered Flow (After Save) on Case: when Priority = 'High' on create, create a follow-up task, send email alert to owner, and update related Account.Last_Case_Priority__c = 'High'.</description>
    <triggerType>RecordChange</triggerType>
    <object>Case</object>
    <triggerTypeConfig>
        <triggerOnCreate>true</triggerOnCreate>
        <triggerOnUpdate>false</triggerOnUpdate>
        <triggerOnDelete>false</triggerOnDelete>
        <entryCriteriaLogicType>All</entryCriteriaLogicType>
        <entryCriteria>
            <criteriaItem>
                <field>Priority</field>
                <operator>equals</operator>
                <value>High</value>
            </criteriaItem>
        </entryCriteria>
        <runAsynchronously>false</runAsynchronously>
        <executeMode>AfterCommit</executeMode>
    </triggerTypeConfig>
    <startElementReference>Start</startElementReference>
    <elements>
        <FlowRecordTriggeredStart>
            <name>Start</name>
            <description>Start: Case created with Priority = High</description>
            <inputParameters>
                <name>recordId</name>
                <dataType>String</dataType>
            </inputParameters>
            <object>Case</object>
            <triggerType>RecordChange</triggerType>
            <filterLogic>All</filterLogic>
            <criteria>
                <field>Priority</field>
                <operator>equals</operator>
                <value>High</value>
            </criteria>
            <isBefore>false</isBefore>
            <commitRecord>false</commitRecord>
        </FlowRecordTriggeredStart>
        <FlowRecordLookup>
            <name>Get_Case_Owner</name>
            <description>Retrieve Case owner User record (Id, Email, Name)</description>
            <object>User</object>
            <conditionLogic>All</conditionLogic>
            <conditions>
                <leftValueReference>{!$Record.OwnerId}</leftValueReference>
                <operator>equals</operator>
                <rightValueReference>Id</rightValueReference>
            </conditions>
            <outputAssignments>
                <assignmentItem>
                    <field>Id</field>
                    <variableName>varOwnerId</variableName>
                </assignmentItem>
                <assignmentItem>
                    <field>Email</field>
                    <variableName>varOwnerEmail</variableName>
                </assignmentItem>
                <assignmentItem>
                    <field>Name</field>
                    <variableName>varOwnerName</variableName>
                </assignmentItem>
            </outputAssignments>
            <storeOutputAutomatically>true</storeOutputAutomatically>
        </FlowRecordLookup>
        <FlowRecordCreate>
            <name>Create_Followup_Task</name>
            <description>Create a Task assigned to Case Owner, related to Case</description>
            <object>Task</object>
            <fieldAssignments>
                <fieldAssignment>
                    <field>Subject</field>
                    <value>Follow up on High Priority Case: {!$Record.CaseNumber}</value>
                </fieldAssignment>
                <fieldAssignment>
                    <field>WhatId</field>
                    <value>{!$Record.Id}</value>
                </fieldAssignment>
                <fieldAssignment>
                    <field>OwnerId</field>
                    <value>{!$Record.OwnerId}</value>
                </fieldAssignment>
                <fieldAssignment>
                    <field>Priority</field>
                    <value>High</value>
                </fieldAssignment>
                <fieldAssignment>
                    <field>ActivityDate</field>
                    <value>{!$Flow.CurrentDate + 2}</value>
                </fieldAssignment>
            </fieldAssignments>
            <storeOutputAutomatically>false</storeOutputAutomatically>
        </FlowRecordCreate>
        <FlowActionCall>
            <name>Send_Email_Alert_To_Owner</name>
            <description>Call Email Alert 'Case_High_Priority_Alert' (must exist in org)</description>
            <actionName>SendEmailAlert</actionName>
            <actionType>EmailAlert</actionType>
            <inputParameters>
                <inputParameter>
                    <name>recordId</name>
                    <value>{!$Record.Id}</value>
                </inputParameter>
                <inputParameter>
                    <name>alertName</name>
                    <value>Case_High_Priority_Alert</value>
                </inputParameter>
            </inputParameters>
        </FlowActionCall>
        <FlowRecordLookup>
            <name>Get_Related_Account</name>
            <description>Retrieve Account related to Case (Id)</description>
            <object>Account</object>
            <conditionLogic>All</conditionLogic>
            <conditions>
                <leftValueReference>{!$Record.AccountId}</leftValueReference>
                <operator>equals</operator>
                <rightValueReference>Id</rightValueReference>
            </conditions>
            <outputAssignments>
                <assignmentItem>
                    <field>Id</field>
                    <variableName>varAccountId</variableName>
                </assignmentItem>
            </outputAssignments>
            <storeOutputAutomatically>true</storeOutputAutomatically>
        </FlowRecordLookup>
        <FlowRecordUpdate>
            <name>Update_Account_Last_Priority</name>
            <description>Update Account.Last_Case_Priority__c to 'High' when related Account exists</description>
            <object>Account</object>
            <filterLogic>All</filterLogic>
            <conditions>
                <leftValueReference>{!varAccountId}</leftValueReference>
                <operator>equals</operator>
                <rightValueReference>Id</rightValueReference>
            </conditions>
            <fieldAssignments>
                <fieldAssignment>
                    <field>Last_Case_Priority__c</field>
                    <value>High</value>
                </fieldAssignment>
            </fieldAssignments>
            <storeOutputAutomatically>false</storeOutputAutomatically>
        </FlowRecordUpdate>
        <FlowApexPluginCall>
            <name>Log_Flow_Error</name>
            <description>Placeholder for fault handling (replace with real logging mechanism)</description>
            <apexClass>Flow_Error_Logger</apexClass>
        </FlowApexPluginCall>
    </elements>
    <connectors>
        <connector>
            <sourceReference>Start</sourceReference>
            <targetReference>Get_Case_Owner</targetReference>
        </connector>
        <connector>
            <sourceReference>Get_Case_Owner</sourceReference>
            <targetReference>Create_Followup_Task</targetReference>
        </connector>
        <connector>
            <sourceReference>Create_Followup_Task</sourceReference>
            <targetReference>Send_Email_Alert_To_Owner</targetReference>
        </connector>
        <connector>
            <sourceReference>Send_Email_Alert_To_Owner</sourceReference>
            <targetReference>Get_Related_Account</targetReference>
        </connector>
        <connector>
            <sourceReference>Get_Related_Account</sourceReference>
            <targetReference>Update_Account_Last_Priority</targetReference>
        </connector>
    </connectors>
    <variables>
        <variable>
            <name>varOwnerId</name>
            <dataType>String</dataType>
        </variable>
        <variable>
            <name>varOwnerEmail</name>
            <dataType>String</dataType>
        </variable>
        <variable>
            <name>varOwnerName</name>
            <dataType>String</dataType>
        </variable>
        <variable>
            <name>varAccountId</name>
            <dataType>String</dataType>
        </variable>
    </variables>
</Flow>